;;;
;;; PgBouncer Configuration for WhatsApp SaaS Starter
;;; Production-grade connection pooling setup
;;;
;;; Deploy this configuration to all application servers
;;; PgBouncer sits between application and PostgreSQL
;;;
;;; Architecture:
;;;   Application -> PgBouncer (localhost:6432) -> PostgreSQL Primary (5432)
;;;                                               -> PostgreSQL Replica 1 (5432)
;;;                                               -> PostgreSQL Replica 2 (5432)
;;;

[databases]
; Primary database for read-write operations
whatsapp_saas_primary = host=primary.db.internal port=5432 dbname=whatsapp_saas pool_size=25

; Read replicas for read-only operations
whatsapp_saas_read1 = host=replica1.db.internal port=5432 dbname=whatsapp_saas pool_size=25
whatsapp_saas_read2 = host=replica2.db.internal port=5432 dbname=whatsapp_saas pool_size=25

; Fallback to local PostgreSQL in development
; whatsapp_saas_dev = host=localhost port=5432 dbname=whatsapp_saas

[pgbouncer]

;;;
;;; Administrative Settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

; Where to listen for connections
listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket (optional)
unix_socket_dir = /var/run/postgresql

; Authentication
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

; Admin user for pgbouncer console
admin_users = pgbouncer_admin

; Stats users (can view stats but not admin commands)
stats_users = pgbouncer_stats

;;;
;;; Connection Pooling Configuration
;;;

; Pool mode
; - session: One server connection per client connection (default, safest)
; - transaction: Server connection returned to pool after each transaction (recommended for microservices)
; - statement: Server connection returned after each statement (dangerous, use with caution)
pool_mode = transaction

; Maximum number of client connections
max_client_conn = 1000

; Default pool size per user/database combination
default_pool_size = 25

; Minimum pool size (connections kept open even when idle)
min_pool_size = 10

; Pool reserve (connections reserved for privileged users when pool is full)
reserve_pool_size = 5

; How many additional connections can be allocated when pool is full
reserve_pool_timeout = 5

; Maximum connections per database
max_db_connections = 100

; Maximum connections per user
max_user_connections = 100

;;;
;;; Timeouts
;;;

; Close server connection if idle for this many seconds
server_idle_timeout = 600

; Drop client connection if it has been waiting for a server for this long
query_wait_timeout = 120

; Cancel query if it takes longer than this
query_timeout = 0

; Close client connection if it has not been serviced in this time
client_idle_timeout = 0

; How long to wait for server connection
server_connect_timeout = 15

; How long to wait before attempting to reconnect
server_reconnect_timeout = 15

;;;
;;; Tuning
;;;

; Buffer size for send and receive
pkt_buf = 4096

; What to do with a connection that has an error
server_reset_query = DISCARD ALL

; Pooler will close client connection immediately if server doesn't reply in this time
server_check_delay = 30

; If a query takes longer than this, it will be logged
log_pooler_errors = 1

;;;
;;; Security
;;;

; TLS/SSL settings
;server_tls_sslmode = prefer
;server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;server_tls_cert_file = /etc/pgbouncer/server.crt
;server_tls_key_file = /etc/pgbouncer/server.key

;;;
;;; Logging and Stats
;;;

; Log disconnections
log_disconnections = 1

; Log connections
log_connections = 1

; Log stats every N seconds
stats_period = 60

; When to rotate log file
logfile_max_size = 100MB

;;;
;;; Advanced Settings
;;;

; Use application name to identify pooled connections
application_name_add_host = 1

; Immediately close connections after client disconnect
server_lifetime = 3600

; How often to check for changes in auth file
auth_user_refresh = 60

; ============================================================================
; EXAMPLE USERLIST.TXT FILE
; Create this file at /etc/pgbouncer/userlist.txt
; ============================================================================
;
; Format: "username" "password"
; Passwords can be:
; - Plain text (not recommended)
; - MD5 hashed: "md5" + md5(password + username)
; - SCRAM-SHA-256 hashed (recommended)
;
; Example entries:
; "app_user" "scram-sha-256$4096:..."
; "read_only_user" "scram-sha-256$4096:..."
; "pgbouncer_admin" "scram-sha-256$4096:..."
;
; To generate SCRAM password:
; 1. Connect to PostgreSQL
; 2. Run: SELECT rolpassword FROM pg_authid WHERE rolname = 'app_user';
; 3. Copy the scram-sha-256 hash to userlist.txt
;
; ============================================================================

; ============================================================================
; INSTALLATION AND SETUP
; ============================================================================
;
; 1. Install PgBouncer:
;    Ubuntu/Debian: sudo apt-get install pgbouncer
;    RHEL/CentOS: sudo yum install pgbouncer
;    Docker: docker pull pgbouncer/pgbouncer
;
; 2. Copy this configuration:
;    sudo cp pgbouncer-config.ini /etc/pgbouncer/pgbouncer.ini
;
; 3. Create userlist.txt:
;    sudo nano /etc/pgbouncer/userlist.txt
;    (Add your database users and passwords)
;
; 4. Set permissions:
;    sudo chown pgbouncer:pgbouncer /etc/pgbouncer/pgbouncer.ini
;    sudo chown pgbouncer:pgbouncer /etc/pgbouncer/userlist.txt
;    sudo chmod 600 /etc/pgbouncer/userlist.txt
;
; 5. Create log directory:
;    sudo mkdir -p /var/log/pgbouncer
;    sudo chown pgbouncer:pgbouncer /var/log/pgbouncer
;
; 6. Start PgBouncer:
;    sudo systemctl enable pgbouncer
;    sudo systemctl start pgbouncer
;
; 7. Update application DATABASE_URL:
;    From: postgresql://user:pass@db.internal:5432/whatsapp_saas
;    To:   postgresql://user:pass@localhost:6432/whatsapp_saas_primary
;
; 8. Monitor PgBouncer:
;    psql -h localhost -p 6432 -U pgbouncer_admin pgbouncer
;    pgbouncer=# SHOW POOLS;
;    pgbouncer=# SHOW STATS;
;    pgbouncer=# SHOW DATABASES;
;
; ============================================================================

; ============================================================================
; MONITORING QUERIES
; ============================================================================
;
; Connect to pgbouncer admin console:
; psql -h localhost -p 6432 -U pgbouncer_admin pgbouncer
;
; Show pool status:
; pgbouncer=# SHOW POOLS;
;
; Show statistics:
; pgbouncer=# SHOW STATS;
;
; Show active databases:
; pgbouncer=# SHOW DATABASES;
;
; Show active clients:
; pgbouncer=# SHOW CLIENTS;
;
; Show active servers:
; pgbouncer=# SHOW SERVERS;
;
; Show configuration:
; pgbouncer=# SHOW CONFIG;
;
; Reload configuration:
; pgbouncer=# RELOAD;
;
; Pause all connections:
; pgbouncer=# PAUSE;
;
; Resume all connections:
; pgbouncer=# RESUME;
;
; ============================================================================

; ============================================================================
; PERFORMANCE TUNING TIPS
; ============================================================================
;
; 1. Pool Size Calculation:
;    pool_size = (num_cpu_cores * 2) + effective_spindle_count
;    For 8-core server with SSD: pool_size = (8 * 2) + 1 = 17
;    Round up to 25 for safety margin
;
; 2. Transaction Mode vs Session Mode:
;    - Use transaction mode for stateless APIs (better pooling)
;    - Use session mode for stateful applications
;    - Never use statement mode unless you know what you're doing
;
; 3. Connection Limits:
;    max_client_conn should be > total expected clients
;    default_pool_size * num_databases should be < PostgreSQL max_connections
;
; 4. Timeout Tuning:
;    - query_wait_timeout: How long client waits for connection
;    - server_idle_timeout: How long to keep idle server connections
;    - Lower values = better resource usage, higher values = fewer reconnects
;
; 5. Read-Write Splitting:
;    - Point write-heavy queries to whatsapp_saas_primary
;    - Point read-only queries to whatsapp_saas_read1/read2
;    - Implement in application layer or use HAProxy
;
; ============================================================================
