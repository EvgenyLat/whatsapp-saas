# PostgreSQL Exporter Configuration for Prometheus
# WhatsApp SaaS Starter - Database Monitoring
#
# This configuration enables comprehensive PostgreSQL monitoring
# Deploy with: docker-compose or kubernetes
#
# Metrics exposed on: http://localhost:9187/metrics

version: '3.8'

services:
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    restart: unless-stopped

    environment:
      # Primary database connection
      DATA_SOURCE_NAME: "postgresql://postgres:${POSTGRES_PASSWORD}@primary.db.internal:5432/whatsapp_saas?sslmode=require"

      # Exporter settings
      PG_EXPORTER_DISABLE_DEFAULT_METRICS: "false"
      PG_EXPORTER_DISABLE_SETTINGS_METRICS: "false"
      PG_EXPORTER_AUTO_DISCOVER_DATABASES: "true"
      PG_EXPORTER_EXTEND_QUERY_PATH: "/etc/postgres-exporter/queries.yaml"

      # Connection settings
      PG_EXPORTER_CONSTANT_LABELS: "environment=production,cluster=whatsapp-saas"

    ports:
      - "9187:9187"

    volumes:
      - ./custom-queries.yaml:/etc/postgres-exporter/queries.yaml:ro

    networks:
      - monitoring

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9187/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Monitor replica databases separately
  postgres-exporter-replica1:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter-replica1
    restart: unless-stopped

    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:${POSTGRES_PASSWORD}@replica1.db.internal:5432/whatsapp_saas?sslmode=require"
      PG_EXPORTER_CONSTANT_LABELS: "environment=production,cluster=whatsapp-saas,role=replica,replica_name=replica1"

    ports:
      - "9188:9187"

    networks:
      - monitoring

  # Prometheus server
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

    ports:
      - "9090:9090"

    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus

    networks:
      - monitoring

  # Alertmanager for sending alerts
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped

    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'

    ports:
      - "9093:9093"

    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager

    networks:
      - monitoring

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped

    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel
      - GF_SERVER_ROOT_URL=http://grafana.yourdomain.com

    ports:
      - "3001:3000"

    volumes:
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - grafana-data:/var/lib/grafana

    networks:
      - monitoring

    depends_on:
      - prometheus

volumes:
  prometheus-data:
  alertmanager-data:
  grafana-data:

networks:
  monitoring:
    driver: bridge

# ============================================================================
# DEPLOYMENT INSTRUCTIONS
# ============================================================================
#
# 1. Create required configuration files:
#    - custom-queries.yaml (custom PostgreSQL metrics)
#    - prometheus.yml (Prometheus configuration)
#    - alerts.yml (alert rules)
#    - alertmanager.yml (alert routing)
#    - grafana-datasources.yml (Grafana data sources)
#
# 2. Set environment variables:
#    export POSTGRES_PASSWORD=your_password
#    export GRAFANA_PASSWORD=your_grafana_password
#
# 3. Deploy the stack:
#    docker-compose -f prometheus-postgres-exporter.yml up -d
#
# 4. Access the services:
#    - Prometheus: http://localhost:9090
#    - Alertmanager: http://localhost:9093
#    - Grafana: http://localhost:3001 (admin/admin)
#
# 5. Import Grafana dashboards:
#    - PostgreSQL Database Dashboard (ID: 9628)
#    - PostgreSQL Exporter Quickstart (ID: 14114)
#
# ============================================================================
