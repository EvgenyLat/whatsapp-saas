# =============================================================================
# PROMTAIL CONFIGURATION
# =============================================================================
# Log shipping agent for the WhatsApp SaaS platform
# Ships logs from application and system to Loki
# =============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# Positions file to track log file positions
positions:
  filename: /tmp/positions.yaml

# Loki client configuration
clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576  # 1MB

    # Retry configuration
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

    # External labels for all logs
    external_labels:
      cluster: 'whatsapp-saas'
      environment: 'production'

# Scrape configurations
scrape_configs:
  # ===========================================================================
  # APPLICATION LOGS - Backend API
  # ===========================================================================
  - job_name: backend-api
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend-api
          service: whatsapp-backend
          tier: application
          __path__: /app/logs/backend-*.log

    # Pipeline stages
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            method: method
            url: url
            statusCode: statusCode
            duration: duration
            userId: userId
            error: error
            stack: stack

      # Extract timestamp
      - timestamp:
          source: timestamp
          format: RFC3339

      # Set log level as label
      - labels:
          level:
          method:
          statusCode:

      # Add severity based on level
      - template:
          source: severity
          template: '{{ if eq .level "error" }}critical{{ else if eq .level "warn" }}warning{{ else }}info{{ end }}'

      # Output structured log line
      - output:
          source: message

  # ===========================================================================
  # APPLICATION LOGS - Webhook Handler
  # ===========================================================================
  - job_name: webhook-handler
    static_configs:
      - targets:
          - localhost
        labels:
          job: webhook-handler
          service: whatsapp-backend
          component: webhook
          tier: application
          __path__: /app/logs/webhook-*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            webhookType: webhookType
            phoneNumber: phoneNumber
            processingTime: processingTime

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          level:
          webhookType:

  # ===========================================================================
  # APPLICATION LOGS - Queue Worker
  # ===========================================================================
  - job_name: queue-worker
    static_configs:
      - targets:
          - localhost
        labels:
          job: queue-worker
          service: whatsapp-backend
          component: queue
          tier: application
          __path__: /app/logs/queue-*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            queueName: queueName
            jobId: jobId
            attempts: attempts
            processingTime: processingTime

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          level:
          queueName:

  # ===========================================================================
  # APPLICATION LOGS - AI Service
  # ===========================================================================
  - job_name: ai-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: ai-service
          service: whatsapp-backend
          component: ai
          tier: application
          __path__: /app/logs/ai-*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            model: model
            tokensUsed: tokensUsed
            duration: duration
            error: error

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          level:
          model:

  # ===========================================================================
  # SYSTEM LOGS - Docker Containers
  # ===========================================================================
  - job_name: docker-containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          tier: infrastructure
          __path__: /var/log/docker/containers/*.log

    pipeline_stages:
      # Parse Docker JSON log format
      - json:
          expressions:
            log: log
            stream: stream
            time: time

      - timestamp:
          source: time
          format: RFC3339Nano

      # Extract container info from filename
      - regex:
          expression: '/var/log/docker/containers/(?P<container_id>[a-f0-9]{64})-json.log'
          source: filename

      - labels:
          stream:
          container_id:

      - output:
          source: log

  # ===========================================================================
  # SYSTEM LOGS - Syslog
  # ===========================================================================
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          tier: infrastructure
          __path__: /var/log/syslog

    pipeline_stages:
      # Parse syslog format
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>\S+)(\[(?P<pid>\d+)\])?: (?P<message>.*)$'

      - timestamp:
          source: timestamp
          format: Jan _2 15:04:05

      - labels:
          hostname:
          process:

      - output:
          source: message

  # ===========================================================================
  # ERROR LOGS - Separate stream for errors
  # ===========================================================================
  - job_name: error-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: errors
          service: whatsapp-backend
          tier: application
          severity: error
          __path__: /app/logs/error-*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            error: error
            stack: stack
            url: url
            userId: userId

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          level:

      # Extract error type
      - regex:
          expression: 'Error: (?P<error_type>\w+)'
          source: error

      - labels:
          error_type:

  # ===========================================================================
  # ACCESS LOGS - HTTP Requests
  # ===========================================================================
  - job_name: access-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: access
          service: whatsapp-backend
          tier: application
          __path__: /app/logs/access-*.log

    pipeline_stages:
      # Parse common log format
      - regex:
          expression: '^(?P<remote_addr>\S+) \S+ \S+ \[(?P<timestamp>[^\]]+)\] "(?P<method>\S+) (?P<url>\S+) \S+" (?P<status>\d+) (?P<bytes>\d+) "(?P<referer>[^"]*)" "(?P<user_agent>[^"]*)" (?P<duration>\d+)ms$'

      - timestamp:
          source: timestamp
          format: 02/Jan/2006:15:04:05 -0700

      - labels:
          method:
          status:

      # Convert duration to metric
      - metrics:
          request_duration_ms:
            type: Histogram
            description: HTTP request duration in milliseconds
            source: duration
            config:
              buckets: [10, 50, 100, 250, 500, 1000, 2500, 5000, 10000]
