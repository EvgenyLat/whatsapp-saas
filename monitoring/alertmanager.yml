# =============================================================================
# ALERTMANAGER CONFIGURATION
# =============================================================================
# Routes alerts to appropriate receivers based on severity and component
# Integrates with Slack for notifications
# =============================================================================

global:
  # Slack API URL (set via environment variable for security)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # Email settings (optional)
  # smtp_smarthost: 'smtp.gmail.com:587'
  # smtp_from: 'alerts@company.com'
  # smtp_auth_username: 'alerts@company.com'
  # smtp_auth_password: '${SMTP_PASSWORD}'

  # Default resolve timeout
  resolve_timeout: 5m

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree
route:
  # Default receiver for all alerts
  receiver: 'slack-general'

  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']

  # Wait before sending a group of alerts
  group_wait: 10s

  # Wait before sending new alerts in an existing group
  group_interval: 10s

  # Wait before re-sending an alert
  repeat_interval: 12h

  # Child routes for specific alert types
  routes:
    # =========================================================================
    # CRITICAL ALERTS - Immediate notification
    # =========================================================================
    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 4h
      continue: true

    # =========================================================================
    # APPLICATION ALERTS
    # =========================================================================
    - match_re:
        component: api|webhook|queue|business|ai
      receiver: 'slack-application'
      group_by: ['alertname', 'component']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h

    # =========================================================================
    # INFRASTRUCTURE ALERTS
    # =========================================================================
    - match_re:
        tier: infrastructure
      receiver: 'slack-infrastructure'
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h

    # =========================================================================
    # DATABASE ALERTS
    # =========================================================================
    - match:
        component: database
      receiver: 'slack-database'
      group_by: ['alertname', 'datname']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h

    # =========================================================================
    # DEPLOYMENT NOTIFICATIONS
    # =========================================================================
    - match:
        alertname: DeploymentStarted
      receiver: 'slack-deployments'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 1h

    - match:
        alertname: DeploymentCompleted
      receiver: 'slack-deployments'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 1h

# Inhibition rules - prevent certain alerts from firing
inhibit_rules:
  # Inhibit warning if critical alert is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # Inhibit database warnings if service is down
  - source_match:
      alertname: 'PostgresDown'
    target_match_re:
      alertname: 'High.*Database.*'
    equal: ['instance']

  # Inhibit Redis warnings if service is down
  - source_match:
      alertname: 'RedisDown'
    target_match_re:
      alertname: 'High.*Redis.*'
    equal: ['instance']

  # Inhibit application alerts if service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      component: 'api|webhook|queue'
    equal: ['instance']

# Receivers configuration
receivers:
  # ===========================================================================
  # SLACK - General Channel
  # ===========================================================================
  - name: 'slack-general'
    slack_configs:
      - channel: '#alerts'
        username: 'Alertmanager'
        icon_emoji: ':bell:'
        title: '{{ if eq .Status "firing" }}üî•{{ else }}‚úÖ{{ end }} [{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Component:* {{ .Labels.component }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

  # ===========================================================================
  # SLACK - Critical Alerts Channel
  # ===========================================================================
  - name: 'slack-critical'
    slack_configs:
      - channel: '#critical-alerts'
        username: 'Critical Alert'
        icon_emoji: ':rotating_light:'
        title: 'üö® CRITICAL ALERT: {{ .GroupLabels.alertname }}'
        text: |
          <!channel> *IMMEDIATE ACTION REQUIRED*

          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Component:* {{ .Labels.component }}
          *Instance:* {{ .Labels.instance }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ if .Annotations.runbook_url }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
        send_resolved: true
        color: 'danger'

  # ===========================================================================
  # SLACK - Application Alerts Channel
  # ===========================================================================
  - name: 'slack-application'
    slack_configs:
      - channel: '#app-alerts'
        username: 'Application Monitor'
        icon_emoji: ':computer:'
        title: '{{ if eq .Status "firing" }}‚ö†Ô∏è{{ else }}‚úÖ{{ end }} Application Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Component:* {{ .GroupLabels.component }}

          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Route:* {{ .Labels.route }}{{ .Labels.method }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

  # ===========================================================================
  # SLACK - Infrastructure Alerts Channel
  # ===========================================================================
  - name: 'slack-infrastructure'
    slack_configs:
      - channel: '#infra-alerts'
        username: 'Infrastructure Monitor'
        icon_emoji: ':gear:'
        title: '{{ if eq .Status "firing" }}‚öôÔ∏è{{ else }}‚úÖ{{ end }} Infrastructure Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Instance:* {{ .GroupLabels.instance }}

          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

  # ===========================================================================
  # SLACK - Database Alerts Channel
  # ===========================================================================
  - name: 'slack-database'
    slack_configs:
      - channel: '#database-alerts'
        username: 'Database Monitor'
        icon_emoji: ':database:'
        title: '{{ if eq .Status "firing" }}üíæ{{ else }}‚úÖ{{ end }} Database Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Database:* {{ .GroupLabels.datname }}
          *Instance:* {{ .GroupLabels.instance }}

          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

  # ===========================================================================
  # SLACK - Deployments Channel
  # ===========================================================================
  - name: 'slack-deployments'
    slack_configs:
      - channel: '#deployments'
        username: 'Deployment Bot'
        icon_emoji: ':rocket:'
        title: 'üöÄ Deployment: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Environment:* {{ .Labels.environment }}
          *Version:* {{ .Labels.version }}
          *Deployed by:* {{ .Labels.deployed_by }}
          *Status:* {{ .Annotations.status }}
          {{ end }}
        send_resolved: false
        color: 'good'

  # ===========================================================================
  # EMAIL RECEIVER (Optional)
  # ===========================================================================
  # - name: 'email-oncall'
  #   email_configs:
  #     - to: 'oncall@company.com'
  #       from: 'alerts@company.com'
  #       smarthost: 'smtp.gmail.com:587'
  #       auth_username: 'alerts@company.com'
  #       auth_identity: 'alerts@company.com'
  #       auth_password: '${SMTP_PASSWORD}'
  #       headers:
  #         Subject: '{{ if eq .Status "firing" }}[ALERT]{{ else }}[RESOLVED]{{ end }} {{ .GroupLabels.alertname }}'
  #       html: |
  #         <h2>{{ if eq .Status "firing" }}üî• Alert Firing{{ else }}‚úÖ Alert Resolved{{ end }}</h2>
  #         {{ range .Alerts }}
  #         <h3>{{ .Annotations.summary }}</h3>
  #         <p>{{ .Annotations.description }}</p>
  #         <ul>
  #           <li><strong>Severity:</strong> {{ .Labels.severity }}</li>
  #           <li><strong>Component:</strong> {{ .Labels.component }}</li>
  #           <li><strong>Started:</strong> {{ .StartsAt }}</li>
  #           {{ if .Annotations.runbook_url }}
  #           <li><a href="{{ .Annotations.runbook_url }}">Runbook</a></li>
  #           {{ end }}
  #         </ul>
  #         {{ end }}

  # ===========================================================================
  # PAGERDUTY RECEIVER (Optional)
  # ===========================================================================
  # - name: 'pagerduty'
  #   pagerduty_configs:
  #     - service_key: '${PAGERDUTY_SERVICE_KEY}'
  #       description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
  #       severity: '{{ .Labels.severity }}'
