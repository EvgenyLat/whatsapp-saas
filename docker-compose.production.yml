##############################################################################
# Docker Compose - Production Configuration
#
# Purpose: Production-ready orchestration for WhatsApp SaaS MVP
#
# Features:
# - Resource limits (CPU, memory)
# - Health checks for all services
# - Restart policies
# - Logging configuration
# - Security hardening
# - Network isolation
# - Persistent volumes
#
# Usage:
#   docker-compose -f docker-compose.production.yml up -d
#   docker-compose -f docker-compose.production.yml logs -f
#   docker-compose -f docker-compose.production.yml down
#
# Note: This is for single-server deployments. For production clusters,
#       use Kubernetes (see kubernetes/ directory) or AWS ECS.
##############################################################################

version: '3.9'

# =============================================================================
# Networks
# =============================================================================
networks:
  backend-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  app-logs:
    driver: local

# =============================================================================
# Services
# =============================================================================
services:

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: whatsapp-saas-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Database password required}
      POSTGRES_DB: ${DB_NAME:-whatsapp_saas}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "1GB"
      POSTGRES_WORK_MEM: "16MB"

    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Custom PostgreSQL configuration
      # - ./config/postgresql.conf:/etc/postgresql/postgresql.conf:ro

    networks:
      - backend-network

    ports:
      - "127.0.0.1:5432:5432"  # Only expose to localhost

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-whatsapp_saas}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    # Security
    security_opt:
      - no-new-privileges:true
    read_only: false  # PostgreSQL needs write access
    tmpfs:
      - /tmp
      - /run

  # ===========================================================================
  # Redis Cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: whatsapp-saas-redis
    restart: unless-stopped

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:?Redis password required}

    volumes:
      - redis-data:/data

    networks:
      - backend-network

    ports:
      - "127.0.0.1:6379:6379"  # Only expose to localhost

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    # Security
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  # ===========================================================================
  # Backend Application
  # ===========================================================================
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +"%Y-%m-%dT%H:%M:%SZ")}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD)}
        VERSION: ${VERSION:-1.0.0}
      # Use BuildKit for better caching
      cache_from:
        - whatsapp-saas-mvp:latest
      target: production

    image: whatsapp-saas-mvp:${VERSION:-latest}
    container_name: whatsapp-saas-backend
    restart: unless-stopped

    environment:
      # Application
      NODE_ENV: production
      PORT: 3000
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Database
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-whatsapp_saas}?schema=public
      DB_CONNECTION_LIMIT: ${DB_CONNECTION_LIMIT:-20}
      DB_POOL_TIMEOUT: ${DB_POOL_TIMEOUT:-20}

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_CONNECTION_LIMIT: ${REDIS_CONNECTION_LIMIT:-10}

      # Secrets (use AWS Secrets Manager in production)
      USE_AWS_SECRETS: ${USE_AWS_SECRETS:-false}
      AWS_REGION: ${AWS_REGION:-us-east-1}

      # Admin
      ADMIN_TOKEN: ${ADMIN_TOKEN:?Admin token required}

      # Meta WhatsApp
      META_VERIFY_TOKEN: ${META_VERIFY_TOKEN:?Meta verify token required}
      META_APP_SECRET: ${META_APP_SECRET:?Meta app secret required}

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OpenAI API key required}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4}

      # Monitoring (optional)
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
      METRICS_PORT: ${METRICS_PORT:-9090}

    volumes:
      # Persistent logs
      - app-logs:/app/logs
      # Temporary files
      - /tmp

    networks:
      - backend-network

    ports:
      - "${APP_PORT:-3000}:3000"      # Application
      - "${METRICS_PORT:-9090}:9090"  # Metrics (Prometheus)

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

    # Security
    security_opt:
      - no-new-privileges:true
    read_only: false  # Application needs to write logs
    tmpfs:
      - /tmp

    # Environment-specific labels
    labels:
      com.whatsapp-saas.service: "backend"
      com.whatsapp-saas.environment: "production"
      com.whatsapp-saas.version: "${VERSION:-latest}"

  # ===========================================================================
  # Nginx Reverse Proxy (Optional)
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: whatsapp-saas-nginx
    restart: unless-stopped
    profiles: ["with-nginx"]

    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/ssl:/etc/nginx/ssl:ro
      - app-logs:/var/log/nginx

    networks:
      - backend-network

    ports:
      - "80:80"
      - "443:443"

    depends_on:
      - backend

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Security
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run

##############################################################################
# Production Deployment Commands
#
# 1. Set environment variables:
#    export DB_PASSWORD=secure-password
#    export REDIS_PASSWORD=secure-password
#    export ADMIN_TOKEN=$(openssl rand -base64 48)
#    export META_VERIFY_TOKEN=$(openssl rand -base64 32)
#    export META_APP_SECRET=your-meta-app-secret
#    export OPENAI_API_KEY=sk-your-openai-key
#
# 2. Create .env.production file:
#    cp .env.example .env.production
#    # Edit .env.production with production values
#
# 3. Start services:
#    docker-compose -f docker-compose.production.yml --env-file .env.production up -d
#
# 4. Check status:
#    docker-compose -f docker-compose.production.yml ps
#    docker-compose -f docker-compose.production.yml logs -f backend
#
# 5. Run database migrations:
#    docker-compose -f docker-compose.production.yml exec backend npx prisma migrate deploy
#
# 6. Scale backend (if needed):
#    docker-compose -f docker-compose.production.yml up -d --scale backend=3
#
# 7. Stop services:
#    docker-compose -f docker-compose.production.yml down
#
# 8. Backup database:
#    docker-compose -f docker-compose.production.yml exec postgres \
#      pg_dump -U postgres whatsapp_saas > backup-$(date +%Y%m%d-%H%M%S).sql
#
# 9. Restore database:
#    docker-compose -f docker-compose.production.yml exec -T postgres \
#      psql -U postgres whatsapp_saas < backup.sql
#
# 10. View resource usage:
#     docker stats
#
# 11. Update to new version:
#     docker-compose -f docker-compose.production.yml pull
#     docker-compose -f docker-compose.production.yml up -d --build
#
##############################################################################

##############################################################################
# Monitoring Integration
#
# To add Prometheus + Grafana monitoring:
#
# 1. Add to this file:
#    - Prometheus service (scrapes /metrics endpoint)
#    - Grafana service (visualization)
#    - Node Exporter (system metrics)
#    - cAdvisor (container metrics)
#
# 2. Configure Prometheus to scrape:
#    - backend:9090/metrics (application metrics)
#    - postgres_exporter:9187/metrics (PostgreSQL metrics)
#    - redis_exporter:9121/metrics (Redis metrics)
#
# 3. Import Grafana dashboards:
#    - Node.js dashboard
#    - PostgreSQL dashboard
#    - Redis dashboard
#
# Example monitoring stack in separate file: docker-compose.monitoring.yml
##############################################################################

##############################################################################
# Security Checklist
#
# Before deploying to production:
# [ ] All passwords are strong and unique
# [ ] Secrets are not in version control
# [ ] TLS/SSL certificates are configured
# [ ] Firewall rules are properly configured
# [ ] Only necessary ports are exposed
# [ ] Services run as non-root users
# [ ] Resource limits are set appropriately
# [ ] Health checks are configured
# [ ] Logging is enabled and monitored
# [ ] Backup procedures are in place
# [ ] Disaster recovery plan is documented
# [ ] Security scanning is performed (Trivy, Snyk)
# [ ] Dependencies are up to date
# [ ] Environment variables are validated
##############################################################################
